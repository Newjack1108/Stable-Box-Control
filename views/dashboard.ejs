<% 
var title = 'Dashboard';
var currentPage = 'dashboard';
%>
<%- include('partials/header') %>
<div class="dashboard">
    <h1>Dashboard</h1>
    <div class="period-info" style="margin-bottom: 2rem; padding: 1rem; background: #f0f7f4; border-radius: 8px; border-left: 4px solid var(--light-green);">
        <p style="margin: 0; color: var(--text-medium); font-size: 0.95rem;">
            <strong>MTD Period:</strong> <%= currentMonth %> (<%= new Date(currentMonthStart).toLocaleDateString('en-GB') %> - <%= new Date(currentMonthEnd).toLocaleDateString('en-GB') %>)
            <% if (last4WeeksStart && last4WeeksEnd) { %>
                | <strong>Last 4 Weeks:</strong> <%= new Date(last4WeeksStart).toLocaleDateString('en-GB') %> - <%= new Date(last4WeeksEnd).toLocaleDateString('en-GB') %>
            <% } %>
        </p>
    </div>
    
    <!-- Section 1: Safety Status -->
    <section class="dashboard-section">
        <h2>Safety Status</h2>
        <div class="metric-card">
            <div class="metric-header">
                <h3>Contribution MTD</h3>
                <span class="rag-badge rag-<%= contributionRAG %>" title="<%= contributionRAG.toUpperCase() %>"></span>
            </div>
            <div class="metric-value">£<%= contributionMTD.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
            <div class="metric-details">
                <p><strong>Period:</strong> <%= currentMonth %></p>
                <p>Target: £<%= parseFloat(settings.monthly_contribution_target).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></p>
                <p>Survival: £<%= parseFloat(settings.survival_contribution).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></p>
                <p><strong>Boxes Sold MTD:</strong> <%= salesMTD.boxes_sold %> × £<%= parseFloat(settings.contribution_per_box).toFixed(2) %> = £<%= contributionMTD.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></p>
                <% if (salesMTD.boxes_sold === 0) { %>
                    <p style="color: #e74c3c; font-weight: 600;">⚠️ No sales data found for <%= currentMonth %></p>
                <% } %>
            </div>
        </div>
    </section>
    
    <!-- Section 2: Box Flow -->
    <section class="dashboard-section">
        <h2>Box Flow</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <h3>Boxes Sold MTD</h3>
                <div class="metric-value"><%= salesMTD.boxes_sold %></div>
                <div class="metric-details">
                    <p><strong>Period:</strong> <%= currentMonth %></p>
                    <% if (salesLast4Weeks && salesLast4Weeks.length > 0) { %>
                        <p><strong>Last 4 Weeks Total:</strong> <%= salesLast4Weeks.reduce((sum, w) => sum + (parseInt(w.boxes_sold) || 0), 0) %></p>
                    <% } %>
                </div>
            </div>
            <div class="metric-card">
                <h3>Boxes Produced MTD</h3>
                <div class="metric-value"><%= productionMTD.boxes_produced %></div>
                <div class="metric-details">
                    <p><strong>Period:</strong> <%= currentMonth %></p>
                    <% if (productionLast4Weeks && productionLast4Weeks.length > 0) { %>
                        <p><strong>Last 4 Weeks Total:</strong> <%= productionLast4Weeks.reduce((sum, w) => sum + (parseInt(w.boxes_produced) || 0), 0) %></p>
                    <% } %>
                </div>
            </div>
            <div class="metric-card">
                <h3>Average Boxes/Week (Last 4 Weeks)</h3>
                <div class="metric-value"><%= avgBoxesPerWeek.toFixed(1) %></div>
                <div class="metric-details">
                    <% if (last4WeeksStart && last4WeeksEnd) { %>
                        <p><strong>Period:</strong> <%= new Date(last4WeeksStart).toLocaleDateString('en-GB') %> - <%= new Date(last4WeeksEnd).toLocaleDateString('en-GB') %></p>
                    <% } %>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Section 3: Install & Extras Mix -->
    <section class="dashboard-section">
        <h2>Install & Extras Mix</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <h3>Install %</h3>
                    <span class="rag-badge rag-<%= installRAG %>" title="<%= installRAG.toUpperCase() %>"></span>
                </div>
                <div class="metric-value"><%= installPct.toFixed(1) %>%</div>
                <div class="metric-details">
                    <p>Target: <%= (parseFloat(settings.target_install_pct) * 100).toFixed(1) %>%</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <h3>Extras %</h3>
                    <span class="rag-badge rag-<%= extrasRAG %>" title="<%= extrasRAG.toUpperCase() %>"></span>
                </div>
                <div class="metric-value"><%= extrasPct.toFixed(1) %>%</div>
                <div class="metric-details">
                    <p>Target: <%= (parseFloat(settings.target_extras_pct) * 100).toFixed(1) %>%</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Section 4: Contribution per Box -->
    <section class="dashboard-section">
        <h2>Contribution per Box</h2>
        <div class="metric-card">
            <div class="metric-header">
                <h3>MTD Contribution per Box</h3>
                <span class="rag-badge rag-<%= contributionPerBoxRAG %>" title="<%= contributionPerBoxRAG.toUpperCase() %>"></span>
            </div>
            <div class="metric-value">£<%= contributionPerBox.toFixed(2) %></div>
            <div class="metric-details">
                <p>Target: £<%= parseFloat(settings.contribution_per_box).toFixed(2) %></p>
            </div>
        </div>
    </section>
    
    <!-- Section 5: Production Guardrails -->
    <section class="dashboard-section">
        <h2>Production Guardrails</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <h3>Cost Compliance</h3>
                    <span class="rag-badge rag-<%= costComplianceRAG %>" title="<%= costComplianceRAG.toUpperCase() %>"></span>
                </div>
                <div class="metric-value"><%= costCompliancePct.toFixed(1) %>%</div>
                <div class="metric-details">
                    <p>Target: <%= (parseFloat(settings.cost_compliance_target) * 100).toFixed(1) %>%</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <h3>Rework per Box</h3>
                    <span class="rag-badge rag-<%= reworkRAG %>" title="<%= reworkRAG.toUpperCase() %>"></span>
                </div>
                <div class="metric-value"><%= reworkPerBox.toFixed(2) %> hrs</div>
                <div class="metric-details">
                    <p>Target: ≤ 0.25 hrs</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Section 6: Forward Look -->
    <section class="dashboard-section">
        <h2>Forward Look (Next 4 Weeks)</h2>
        <% if (forwardLook && forwardLook.length > 0) { %>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Week Commencing</th>
                        <th>Boxes Sold</th>
                        <th>Installs Capacity</th>
                    </tr>
                </thead>
                <tbody>
                    <% forwardLook.forEach(week => { %>
                        <tr>
                            <td><%= new Date(week.week_commencing).toLocaleDateString('en-GB') %></td>
                            <td><%= week.boxes_sold || 0 %></td>
                            <td><%= Math.round((week.boxes_sold || 0) * parseFloat(settings.target_install_pct)) %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <p class="no-data">No forward look data available</p>
        <% } %>
    </section>
    
    <!-- Settings Panel (Protected) -->
    <% if (isAuthenticated) { %>
    <section class="dashboard-section">
        <h2>Settings <button class="btn-toggle" onclick="toggleSettings()">Show/Hide</button></h2>
        <div id="settings-panel" style="display: none;">
            <form id="settings-form" onsubmit="updateSettings(event)">
                <h3 style="margin-bottom: 1rem; color: var(--dark-green);">Primary Settings</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="annual_turnover">Annual Turnover (£):</label>
                        <input type="number" id="annual_turnover" name="annual_turnover" 
                               value="<%= settings.annual_turnover || '' %>" step="0.01" min="0">
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Used to calculate monthly contribution target</small>
                    </div>
                    <div class="form-group">
                        <label for="base_box_price">Base Box Price (£):</label>
                        <input type="number" id="base_box_price" name="base_box_price" 
                               value="<%= settings.base_box_price || '' %>" step="0.01" min="0">
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Base price before installs/extras</small>
                    </div>
                    <div class="form-group">
                        <label for="gross_margin_pct">Gross Margin %:</label>
                        <input type="number" id="gross_margin_pct" name="gross_margin_pct" 
                               value="<%= settings.gross_margin_pct || 0.35 %>" step="0.01" min="0" max="1" required>
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Default: 0.35 (35%)</small>
                    </div>
                    <div class="form-group">
                        <label for="target_install_pct">Target Install %:</label>
                        <input type="number" id="target_install_pct" name="target_install_pct" 
                               value="<%= settings.target_install_pct %>" step="0.01" min="0" max="1" required>
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Percentage of total sale (e.g., 0.20 = 20%)</small>
                    </div>
                    <div class="form-group">
                        <label for="target_extras_pct">Target Extras %:</label>
                        <input type="number" id="target_extras_pct" name="target_extras_pct" 
                               value="<%= settings.target_extras_pct %>" step="0.01" min="0" max="1" required>
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Percentage of total sale (e.g., 0.20 = 20%)</small>
                    </div>
                    <div class="form-group">
                        <label for="survival_contribution">Survival Contribution (£):</label>
                        <input type="number" id="survival_contribution" name="survival_contribution" 
                               value="<%= settings.survival_contribution %>" step="0.01" required>
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Minimum monthly contribution</small>
                    </div>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--dark-green);">Calculated Values</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Monthly Contribution Target (£):</label>
                        <input type="number" id="monthly_contribution_target" name="monthly_contribution_target" 
                               value="<%= settings.monthly_contribution_target %>" step="0.01" 
                               style="background-color: #f0f7f4; border-color: var(--light-green);" readonly>
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Calculated from Annual Turnover × Gross Margin ÷ 12</small>
                    </div>
                    <div class="form-group">
                        <label>Contribution per Box (£):</label>
                        <input type="number" id="contribution_per_box" name="contribution_per_box" 
                               value="<%= settings.contribution_per_box %>" step="0.01"
                               style="background-color: #f0f7f4; border-color: var(--light-green);" readonly>
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Calculated from Base Box Price × (1 + Install % + Extras %) × Gross Margin</small>
                    </div>
                    <div class="form-group">
                        <label>Target Boxes per Month:</label>
                        <input type="number" id="target_boxes_per_month" name="target_boxes_per_month" 
                               value="<%= settings.target_boxes_per_month %>"
                               style="background-color: #f0f7f4; border-color: var(--light-green);" readonly>
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Calculated from Monthly Contribution ÷ Contribution per Box</small>
                    </div>
                    <div class="form-group">
                        <label>Target Boxes per Week:</label>
                        <input type="number" id="target_boxes_per_week" name="target_boxes_per_week" 
                               value="<%= settings.target_boxes_per_week %>"
                               style="background-color: #f0f7f4; border-color: var(--light-green);" readonly>
                        <small style="color: var(--text-medium); font-size: 0.85rem;">Calculated from Target Boxes per Month ÷ 4.33</small>
                    </div>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--dark-green);">Other Settings</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cost_compliance_target">Cost Compliance Target:</label>
                        <input type="number" id="cost_compliance_target" name="cost_compliance_target" 
                               value="<%= settings.cost_compliance_target %>" step="0.01" min="0" max="1" required>
                    </div>
                    <div class="form-group">
                        <label for="right_first_time_target">Right First Time Target:</label>
                        <input type="number" id="right_first_time_target" name="right_first_time_target" 
                               value="<%= settings.right_first_time_target %>" step="0.01" min="0" max="1" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update Settings</button>
            </form>
        </div>
    </section>
    <% } %>
</div>

<script>
function toggleSettings() {
    const panel = document.getElementById('settings-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

async function updateSettings(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Settings updated successfully');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error updating settings: ' + error.error);
        }
    } catch (error) {
        alert('Error updating settings: ' + error.message);
    }
}
</script>
<%- include('partials/footer') %>
